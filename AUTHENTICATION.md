# Authentication System Documentation

Complete authentication system for Jimpitan Mobile app following Clean Architecture principles.

## Project Structure

```
lib/
├── core/
│   ├── dio_provider.dart              # HTTP client configuration
│   └── helpers/
│       ├── callback_parser.dart        # Helper for parsing Google Apps Script responses
│       └── README.md                   # CallbackParser documentation
├── data/
│   ├── models/
│   │   └── auth/
│   │       ├── auth_model.dart         # Auth models with Freezed
│   │       ├── auth_model.freezed.dart # Generated by Freezed
│   │       └── auth_model.g.dart       # Generated by json_serializable
│   ├── remote/
│   │   └── auth/
│   │       └── auth_remote_source.dart # API calls implementation
│   └── repositories/
│       └── auth_repository_impl.dart   # Repository implementation
├── domain/
│   ├── repositories/
│   │   └── auth_repository.dart        # Repository interface
│   └── usecases/
│       └── login_usecase.dart          # Login business logic
└── presentation/
    └── auth/
        ├── auth_controller.dart        # State management
        └── login_page.dart             # Login UI
```

## API Specification

### Login Endpoint

**Method:** GET
**URL:** `{{jimpitan_url}}?action=login&username={{username}}&password={{password}}`

**Query Parameters:**

- `action`: "login"
- `username`: User's username
- `password`: User's password

**Response Format:**

```javascript
callback({
    "status": "success",
    "message": "Login berhasil",
    "data": {
        "id": "USR-002",
        "name": "Udin",
        "role": "petugas",
        "username": "udin",
        "token": "kvwZJ2fJNMkCiZLwzWIsnCZfzg2kWMBR",
        "tokenExpiry": "2025-12-01T16:16:44.100Z",
        "lastLogin": "2025-11-24T16:16:44.100Z"
    }
})
```

## Data Models

### AuthRequestModel

```dart
class AuthRequestModel {
  final String username;
  final String password;
}
```

### AuthUserModel

```dart
class AuthUserModel {
  final String id;
  final String name;
  final String role;
  final String username;
  final String token;
  final String tokenExpiry;
  final String lastLogin;
}
```

### AuthResponseModel

```dart
class AuthResponseModel {
  final String status;
  final String? message;
  final AuthUserModel? data;

  // Helper method
  bool get isSuccess => status.toLowerCase() == 'success';
}
```

## Features

### ✅ Implemented Features

1. **Clean Architecture**
   - Separation of concerns (Data, Domain, Presentation)
   - Repository pattern
   - Use cases for business logic

2. **State Management**
   - Riverpod for global state
   - StateNotifier for auth state
   - Reactive UI updates

3. **Authentication Flow**
   - Login page with validation
   - User session management
   - Logout functionality
   - Route protection

4. **UI Features**
   - Beautiful Material Design login page
   - Loading states
   - Error handling with SnackBars
   - Password visibility toggle
   - Form validation

5. **Response Parsing**
   - CallbackParser helper for Google Apps Script responses
   - Handles callback wrapper removal
   - JSON parsing with error handling
   - 302 redirect handling

6. **Integration**
   - HomePage shows user info
   - InputPage requires authentication
   - Auto-fills user data in forms
   - Logout confirmation dialog

## Usage

### Login Flow

1. User opens app → Redirected to LoginPage
2. User enters credentials
3. Tap "Login" button
4. AuthController calls LoginUseCase
5. LoginUseCase calls AuthRepository
6. AuthRepository calls AuthRemoteDataSource
7. API response parsed using CallbackParser
8. User data stored in AuthController state
9. Navigate to HomePage
10. User can access InputPage

### Logout Flow

1. User taps profile menu in HomePage
2. Selects "Logout"
3. Confirmation dialog appears
4. Confirm logout
5. AuthController clears state
6. Navigate to LoginPage

## Code Examples

### Using AuthController

```dart
// Login
ref.read(authControllerProvider.notifier).login(
  username: 'udin',
  password: 'password123',
);

// Check auth state
final authState = ref.watch(authControllerProvider);
if (authState.user != null) {
  // User is authenticated
  print('Welcome ${authState.user!.name}');
}

// Logout
ref.read(authControllerProvider.notifier).logout();
```

### Protecting Routes

```dart
@override
void initState() {
  super.initState();
  WidgetsBinding.instance.addPostFrameCallback((_) {
    final authState = ref.read(authControllerProvider);
    if (authState.user == null) {
      context.go('/login');
    }
  });
}
```

### Using CallbackParser

```dart
try {
  final response = await dio.get('endpoint');
  final jsonMap = CallbackParser.parse(response.data);
  return YourModel.fromJson(jsonMap);
} catch (e) {
  // Handle error
}
```

## Demo Credentials

**Username:** udin
**Password:** password123

## Future Enhancements

- [ ] Token persistence (SharedPreferences/SecureStorage)
- [ ] Auto-refresh token
- [ ] Remember me functionality
- [ ] Biometric authentication
- [ ] Password reset flow
- [ ] Multi-language support
- [ ] Error logging and analytics

## Testing

To test the authentication:

1. Run the app: `flutter run`
2. You'll see the login page
3. Enter demo credentials (udin/password123)
4. Login successfully → HomePage
5. Tap "+" to go to InputPage
6. Petugas and Username are auto-filled from logged-in user
7. Tap profile icon → Logout

## Notes

- The app uses Google Apps Script for backend
- All responses are wrapped in `callback()` function
- CallbackParser helper handles this automatically
- Auth state is managed globally with Riverpod
- Routes are protected - unauthenticated users can't access InputPage
- Base URL is configured in `dio_provider.dart`
